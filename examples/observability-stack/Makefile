.PHONY: help start stop restart logs clean traffic test

help: ## Show this help message
	@echo "Full Observability Stack - Available commands:"
	@echo ""
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | sort | awk 'BEGIN {FS = ":.*?## "}; {printf "  \033[36m%-15s\033[0m %s\n", $$1, $$2}'
	@echo ""

start: ## Start all services (Mimir, Tempo, Loki, Grafana, Collector, App)
	@echo "ðŸš€ Starting observability stack..."
	@docker compose up -d
	@echo ""
	@echo "âœ… Services started!"
	@echo ""
	@echo "Access URLs:"
	@echo "  Grafana:     http://localhost:3000"
	@echo "  Application: http://localhost:8080"
	@echo ""
	@echo "Run 'make logs' to view logs"
	@echo "Run 'make traffic' to generate test traffic"

stop: ## Stop all services
	@echo "ðŸ›‘ Stopping services..."
	@docker compose stop

restart: ## Restart all services
	@echo "ðŸ”„ Restarting services..."
	@docker compose restart

logs: ## Show logs from all services
	@docker compose logs -f

logs-app: ## Show logs from the application only
	@docker compose logs -f app

logs-collector: ## Show logs from OTEL collector only
	@docker compose logs -f otel-collector

clean: ## Stop and remove all containers and volumes
	@echo "ðŸ§¹ Cleaning up..."
	@docker compose down -v
	@echo "âœ… Cleanup complete!"

traffic: ## Generate test traffic to the application
	@./generate-traffic.sh

test: ## Run a quick test of all endpoints
	@echo "ðŸ§ª Testing endpoints..."
	@echo ""
	@echo "Testing /health..."
	@curl -s http://localhost:8080/health | jq . || echo "âŒ Failed"
	@echo ""
	@echo "Testing /hello..."
	@curl -s http://localhost:8080/hello | jq . || echo "âŒ Failed"
	@echo ""
	@echo "Testing /process/test123..."
	@curl -s http://localhost:8080/process/test123 | jq . || echo "âŒ Failed"
	@echo ""
	@echo "âœ… Tests complete!"

status: ## Show status of all services
	@docker compose ps

grafana: ## Open Grafana in browser
	@echo "Opening Grafana..."
	@xdg-open http://localhost:3000 2>/dev/null || open http://localhost:3000 2>/dev/null || echo "Please open http://localhost:3000 in your browser"

build: ## Rebuild the application container
	@echo "ðŸ”¨ Building application..."
	@docker compose build app

rebuild: build restart ## Rebuild and restart the application
